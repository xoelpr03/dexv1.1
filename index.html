<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon Ultimate Dex</title>
    <style>
        :root { 
    --scarlet: #ff2424; 
    --violet: #8c47ff; 
    --accent: #3c5aa6;
    --silver-light: #f8fafc;
    --silver-mid: #e2e8f0;
    --silver-dark: #94a3b8;
}

body { 
    font-family: 'Inter', sans-serif; 
    margin: 0; padding: 0; 
    color: #1e293b; 
    min-height: 100vh; 
    background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 50%, #e2e8f0 100%); 
    background-attachment: fixed;
}

body.theme-sv { background: linear-gradient(135deg, var(--scarlet) 0%, var(--violet) 100%); }

.container { max-width: 1100px; margin: auto; padding: 10px; box-sizing: border-box; }

/* --- SEARCH SECTION --- */
#search-section { 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    width: 100%;
    transition: all 0.3s ease;
}

.search-box-container { 
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    padding: 30px 20px; 
    border-radius: 30px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
    text-align: center; 
    width: 90%; 
    max-width: 600px; 
}

.dex-title { 
    margin:0 0 20px 0; 
    background: linear-gradient(90deg, #3c5aa6, #ffcb05); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    font-size: clamp(24px, 8vw, 38px); 
    font-weight: 900; 
    cursor: pointer; 
}

.nav-input { flex-grow: 1; padding: 15px; border: 3px solid #e2e8f0; border-radius: 15px; outline: none; font-size: 16px; }
.search-btn { background: var(--accent); color: white; border: none; border-radius: 15px; padding: 0 20px; font-weight: 800; cursor: pointer; }

/* --- DISPLAY CARD --- */
#display-card { 
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 24px; 
    padding: 20px; 
    box-shadow: 0 20px 40px rgba(0,0,0,0.08); 
    border: 1px solid white;
    margin-top: 10px; 
    display: none;
}

.layout-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }

/* --- VARIANTS SECTION --- */
#formsArea {
    background: rgba(255, 255, 255, 0.5) !important;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(226, 232, 240, 0.6) !important;
    padding: 20px;
    border-radius: 20px;
    margin-bottom: 25px;
}

#formsList {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.variant-btn {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 12px;
    padding: 8px 14px;
    font-size: 11px;
    font-weight: 800;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.variant-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

/* --- CREATOR CREDIT --- */
.creator-credit {
    margin-top: 30px;
    font-size: 10px;
    font-weight: 800;
    text-transform: lowercase;
    letter-spacing: 2px;
    color: var(--silver-dark);
    opacity: 0.6;
    text-align: center;
    border-top: 1px solid var(--silver-light);
    padding-top: 15px;
    width: 200px;
    margin: 30px auto 0;
}

/* --- MOBILE OPTIMIZATION --- */
@media (max-width: 850px) {
    .layout-grid { grid-template-columns: 1fr; }
    #pokeImg { width: 220px !important; margin: auto; }
}

@media (max-width: 600px) {
    #search-section { height: 100vh; }
    .search-box-container { width: 95%; padding: 20px 15px; }
    #pokeName { font-size: 26px !important; text-align: center; }
    .dex-title { font-size: 28px !important; }
    #formsList { display: grid; grid-template-columns: 1fr 1fr; }
    .variant-btn { text-align: center; padding: 12px 5px; }
}
    </style>
</head>
<body>
<div class="container">
    <div id="search-section">
        <div class="search-box-container">
            <h1 class="dex-title" onclick="location.reload()">Pokémon Ultimate Dex</h1>
            <div class="main-nav">
                <div class="search-wrapper">
                    <input type="text" id="pokeIn" class="nav-input" placeholder="Name or ID..." autocomplete="off">
                    <button class="search-btn" id="goBtn">GO</button>
                    <div id="pokeSuggs" class="suggestions"></div>  <!-- Contenedor para sugerencias -->
                </div>
            </div>
            <div class="creator-credit">created by ξawsjake</div>
        </div>
    </div>

    <div id="display-card">
        <div id="formsArea" style="background: #f8fafc; padding: 15px; border-radius: 18px; margin-bottom: 20px; border: 1px solid #e2e8f0; display: none;">
            <span style="font-size:11px; font-weight:900; color:#94a3b8; display: block; margin-bottom: 12px; letter-spacing: 1px;">AVAILABLE VARIANTS</span>
            <div id="formsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        </div>

        <div class="header-flex">
            <button class="back-btn" onclick="goBack()">← BACK</button>
            <div class="game-switcher">
                <button id="btn-sv" 
                        class="game-btn active" 
                        style="background: linear-gradient(to right, var(--scarlet), var(--violet)); 
                        border-radius: 50px; 
                        border: none; 
                        padding: 10px 20px; 
                        color: white; 
                        cursor: pointer; 
                        font-weight: bold;" 
                        onclick="setGame('sv', this)">
                        S / V
                </button>
            </div>
            <button id="shinySparkle" class="shiny-btn" onclick="toggleShiny()">✨</button>
        </div>

        <div class="layout-grid">
            <div style="text-align: center; position: relative;">
                <div id="dexNumber" style="font-weight: 900; color: #94a3b8; font-size: 20px;">#0000</div>
                <img id="pokeImg" src="" style="width: 250px; max-width: 90%; height: auto; display:block; margin: auto;">
                
                <div id="nav-pokes" style="display:flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <!-- JS pondrá los botones -->
                </div>
                
                <div id="pokeTypes" style="margin-top: 10px;"></div>
                <div id="stats-area" style="margin-top: 20px; text-align: left; background: #f8fafc; padding: 15px; border-radius: 12px;"></div>
            </div>
            
            <div>
                <h2 id="pokeName" style="margin: 0; font-size: 32px; text-transform: capitalize;"></h2>
                <div id="pCat" style="color: #64748b; font-weight: bold; font-size: 14px; margin-bottom: 15px;"></div>
                
                <div style="background:#f1f5f9; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <span style="font-size:10px; font-weight:900; color:#64748b">EVOLUTION CHAIN</span>
                    <div id="evoChain" style="display:flex; overflow-x: auto; gap:15px; margin-top:10px; align-items: center; padding-bottom: 10px; scrollbar-width: thin;"></div>
                </div>

                <div id="abilitiesArea" style="font-size: 14px; line-height: 1.4;"></div>

                <div style="margin-top:25px;">
                    <div style="display:flex; gap:8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none;">
                        <button class="v-toggle" onclick="setMoveMode('level-up', this)">Level</button>
                        <button class="v-toggle" onclick="setMoveMode('machine', this)">TM</button>
                        <button class="v-toggle" onclick="setMoveMode('egg', this)">Egg</button>
                        <button class="v-toggle active" onclick="setMoveMode('all', this)">All</button>
                    </div>
                    <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #f1f5f9;">
                        <table>
                            <thead><tr><th>Lvl</th><th>Move</th><th>Type</th><th>Pwr</th></tr></thead>
                            <tbody id="movesBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let allPokes = [], currentPoke = null, isShiny = false, activeVer = 'scarlet', activeGame = 'sv', moveMode = 'all';
    const typeColors = { grass: '#7AC74C', fire: '#EE8130', water: '#6390F0', bug: '#A6B91A', normal: '#A8A77A', poison: '#A33EA1', electric: '#F7D02C', ground: '#E2BF65', fairy: '#D685AD', fighting: '#C22E28', psychic: '#F95587', rock: '#B6A136', ghost: '#735797', ice: '#96D9D6', dragon: '#6F35FC', dark: '#705746', steel: '#B7B7CE', flying: '#A98FF3' };
    const cap = s => s.replace(/-/g,' ').replace(/\b\w/g, l => l.toUpperCase());

    function getStatColor(v) {
        if(v < 50) return '#ff4d4d'; if(v < 80) return '#ff944d'; if(v < 100) return '#ffdb4d';
        if(v < 120) return '#52be80'; if(v < 150) return '#5dade2'; return '#af7ac5';
    }

    window.onload = async () => {
        const data = await (await fetch('https://pokeapi.co/api/v2/pokemon-species?limit=1025')).json();
        allPokes = data.results.map((p, i) => ({ name: p.name, id: i + 1 }));
        setupSearch('pokeIn', 'pokeSuggs', allPokes, loadPokemon);
    };

    function goBack() {
        document.getElementById('display-card').style.display = 'none';
        document.getElementById('search-section').style.display = 'flex';
        document.body.className = '';
        window.scrollTo(0,0);
    }

    // --- REPAIRED LOAD FUNCTION ---
    async function loadPokemon(name) {
        try {
            // First try to get basic data to find the species
            let pokeData, speciesData;
            
            try {
                // Try fetching as a specific variety/form first
                pokeData = await (await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase()}`)).json();
                speciesData = await (await fetch(pokeData.species.url)).json();
            } catch (e) {
                // If that fails, try fetching as a species (default form)
                speciesData = await (await fetch(`https://pokeapi.co/api/v2/pokemon-species/${name.toLowerCase()}`)).json();
                const defaultUrl = speciesData.varieties.find(v => v.is_default).pokemon.url;
                pokeData = await (await fetch(defaultUrl)).json();
            }

            const evoData = await (await fetch(speciesData.evolution_chain.url)).json();

            currentPoke = { species: speciesData, poke: pokeData, evo: evoData };
            
            document.getElementById('search-section').style.display = 'none';
            document.getElementById('display-card').style.display = 'block';
            
            render();
            window.scrollTo(0, 0);
        } catch (err) {
            console.error(err);
            alert("Pokémon or Form not found!");
        }
    }

    async function render() {
        const { species, poke, evo } = currentPoke;
        document.getElementById('pokeName').innerText = cap(poke.name);
        document.getElementById('dexNumber').innerText = `#${species.id.toString().padStart(4, '0')}`;
        
        // Handle Shiny Toggle
        document.getElementById('pokeImg').src = isShiny ? 
            (poke.sprites.other.home.front_shiny || poke.sprites.front_shiny) : 
            (poke.sprites.other.home.front_default || poke.sprites.front_default);

        document.getElementById('pokeTypes').innerHTML = poke.types.map(t => `<span class="type-badge" style="background:${typeColors[t.type.name]}">${t.type.name}</span>`).join('');
        document.getElementById('pCat').innerText = species.genera.find(g => g.language.name==='en')?.genus || "";
        
        // Render Stats (The fix for dynamic stats is here)
        let statsHtml = "";
        poke.stats.forEach(s => {
            const shortName = s.stat.name.replace('special-', 'S').substring(0,3).toUpperCase();
            statsHtml += `<div class="stat-row">
                <div style="width:35px">${shortName}</div>
                <div style="width:35px; text-align:right">${s.base_stat}</div>
                <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${(s.base_stat/255)*100}%; background:${getStatColor(s.base_stat)}"></div></div>
            </div>`;
        });
        document.getElementById('stats-area').innerHTML = statsHtml;

       // Render Abilities
let absHtml = "";

// 1. Filter out duplicates based on the ability name
const uniqueAbilities = poke.abilities.filter((ability, index, self) =>
    index === self.findIndex((a) => a.ability.name === ability.ability.name)
);

for(let a of uniqueAbilities) {
    // 2. Only show (HA) badge if there's more than one UNIQUE ability
    const showHA = a.is_hidden && uniqueAbilities.length > 1;
    
    const d = await (await fetch(a.ability.url)).json();
    const entry = d.effect_entries.find(e => e.language.name === 'en');
    
    absHtml += `
        <div style="margin-bottom:12px; font-size: 13px; line-height: 1.4;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                <strong style="color: #1e293b; letter-spacing: 0.5px;">
                    ${cap(a.ability.name).toUpperCase()}
                </strong>
                ${showHA ? `<span style="font-size: 9px; font-weight: 800; color: var(--silver-dark); background: var(--silver-light); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--silver-mid);">HA</span>` : ''}
            </div>
            <div style="color: #64748b; font-size: 12px;">
                ${entry ? entry.short_effect : "No info available."}
            </div>
        </div>`;
}
document.getElementById('abilitiesArea').innerHTML = absHtml;

        renderEvoChain(evo.chain);
        renderFormsList();
        renderMoves();
    }

    function renderFormsList() {
        const varieties = currentPoke.species.varieties;
        const area = document.getElementById('formsArea');
        const list = document.getElementById('formsList');

        if (varieties.length <= 1) {
            area.style.display = 'none';
            return;
        }

        area.style.display = 'block';
        list.innerHTML = varieties.map(v => {
            const isCurrent = v.pokemon.name === currentPoke.poke.name;
            const label = v.is_default ? 'BASE' : v.pokemon.name.replace(currentPoke.species.name + '-', '').toUpperCase();
            return `<button class="form-btn ${isCurrent ? 'active' : ''}" onclick="loadForm('${v.pokemon.name}')">${label}</button>`;
        }).join('');
    }

    async function loadForm(variantName) {
        const pokeData = await (await fetch(`https://pokeapi.co/api/v2/pokemon/${variantName}`)).json();
        currentPoke.poke = pokeData;
        render(); // This ensures stats and images refresh
    }

    // --- SEARCH LOGIC ---
    function setupSearch(id, sugId, list, cb) {
        const inp = document.getElementById(id), sug = document.getElementById(sugId), goBtn = document.getElementById('goBtn');
        inp.oninput = () => {
            const val = inp.value.toLowerCase();
            sug.innerHTML = "";
            if(!val) { sug.style.display = "none"; return; }
            const matches = list.filter(p => p.name.includes(val) || p.id.toString() === val).slice(0, 10);
            sug.style.display = matches.length ? "block" : "none";
            matches.forEach(m => {
                const d = document.createElement('div');
                d.className = "list-item";
                d.innerHTML = `<span style="color:#94a3b8; font-weight:bold; margin-right:10px;">#${m.id}</span>${cap(m.name)}`;
                d.onclick = () => { cb(m.name); sug.style.display="none"; inp.value=""; };
                sug.appendChild(d);
            });
        };
        goBtn.onclick = () => { if(inp.value) cb(inp.value); };
    }

    function toggleShiny() {
        isShiny = !isShiny;
        document.getElementById('shinySparkle').classList.toggle('active');
        render();
    }

    // --- Placeholder for other functions to keep code running ---
    function setGame(g, btn) { activeGame = g; render(); }
    function setMoveMode(mode, btn) {
        moveMode = mode;
        // Update active class on buttons
        document.querySelectorAll('.v-toggle').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderMoves();
    }
    async function renderMoves() {
    const body = document.getElementById('movesBody');
    if (!currentPoke || !currentPoke.poke) return;
    
    body.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>Loading moves...</td></tr>";

    const poke = currentPoke.poke;
    const vGroup = activeGame === 'sv' ? 'scarlet-violet' : 'sword-shield';

    // 1. Filter moves based on the selected mode
    let movesList = poke.moves.filter(m => {
        return m.version_group_details.some(v => {
            const matchVersion = v.version_group.name === vGroup;
            const matchMethod = (moveMode === 'all' || v.move_learn_method.name === moveMode);
            return matchVersion && matchMethod;
        });
    });

    // 2. Sort
    if (moveMode === 'level-up' || moveMode === 'all') {
        movesList.sort((a, b) => {
            const aDet = a.version_group_details.find(v => v.version_group.name === vGroup && v.move_learn_method.name === 'level-up');
            const bDet = b.version_group_details.find(v => v.version_group.name === vGroup && v.move_learn_method.name === 'level-up');
            return (aDet?.level_learned_at || 0) - (bDet?.level_learned_at || 0);
        });
    }

    if (movesList.length === 0) {
        body.innerHTML = `<tr><td colspan='4' style='text-align:center; padding:20px;'>No moves found.</td></tr>`;
        return;
    }

    let html = "";
    try {
        const movePromises = movesList.slice(0, 80).map(async (m) => {
            const res = await fetch(m.move.url);
            const data = await res.json();
            
            // FIND THE SPECIFIC DETAIL FOR THE CURRENT MODE
            // If mode is 'all', we look for level-up first to show the number
            let detail;
            if (moveMode === 'all') {
                detail = m.version_group_details.find(v => v.version_group.name === vGroup && v.move_learn_method.name === 'level-up') 
                         || m.version_group_details.find(v => v.version_group.name === vGroup);
            } else {
                detail = m.version_group_details.find(v => v.version_group.name === vGroup && v.move_learn_method.name === moveMode);
            }

            // FORCE DASH FOR TM AND EGG MODES
            let displayLvl = '—';
            if (detail && detail.move_learn_method.name === 'level-up') {
                displayLvl = detail.level_learned_at;
            }
            // Additional safety: if user clicked 'machine', force it to dash
            if (moveMode === 'machine' || moveMode === 'egg') {
                displayLvl = '—';
            }

            return {
                lvl: displayLvl,
                name: m.move.name,
                type: data.type.name,
                power: data.power || '—',
                category: data.damage_class.name
            };
        });

        const moveDataResults = await Promise.all(movePromises);

        moveDataResults.forEach(m => {
            if (!m) return;
            const catIcon = `<span class="cat-icon cat-${m.category}"></span>`;
            html += `
                <tr>
                    <td style="font-weight:bold; color:#64748b; text-align:center; width:40px;">${m.lvl}</td>
                    <td style="font-weight:bold; font-variant: small-caps; font-size: 14px;">
                        ${catIcon}${m.name.replace(/-/g, ' ')}
                    </td>
                    <td style="width:80px;">
                        <span class="type-badge" style="background:${typeColors[m.type]}; margin:0; font-size:9px; display:block; text-align:center;">
                            ${m.type}
                        </span>
                    </td>
                    <td style="font-weight:bold; text-align:center; width:40px;">${m.power}</td>
                </tr>`;
        });

        body.innerHTML = html;
    } catch (err) {
        body.innerHTML = "<tr><td colspan='4'>Error loading moves.</td></tr>";
    }
}

    // Generar las filas de la tabla con los movimientos
    const movesBody = document.getElementById('movesBody');
    movesBody.innerHTML = ''; // Limpiar cualquier contenido anterior

    movesList.forEach(m => {
        const moveDetails = m.move;
        const moveType = moveDetails.type.name; // Tipo del movimiento
        const movePower = moveDetails.power || '-'; // Poder del movimiento (si existe)

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${m.version_group_details[0].level_learned_at || '-'}</td>
            <td>${cap(moveDetails.name)}</td>
            <td><span class="type-badge" style="background:${typeColors[moveType]}">${moveType}</span></td>
            <td>${movePower}</td>
        `;
        movesBody.appendChild(row);
    });
    async function renderEvoChain(chain) {
    const container = document.getElementById('evoChain');
    container.innerHTML = ""; 

    // Main entry point
    await renderBranch(chain, container);

   async function renderBranch(stage, targetContainer) {
    const column = document.createElement('div');
    column.style.cssText = "display: flex; flex-direction: column; align-items: center; gap: 10px;";
    
    // 1. Fetch species data for variants
    const speciesRes = await fetch(stage.species.url);
    const speciesData = await speciesRes.json();
    const forms = speciesData.varieties.filter(v => 
        v.pokemon.name.includes('-alola') || v.pokemon.name.includes('-galar') || 
        v.pokemon.name.includes('-hisui') || v.pokemon.name.includes('-paldea') || v.is_default
    );

    const formsBox = document.createElement('div');
    formsBox.style.cssText = "display: flex; flex-direction: column; gap: 5px; align-items: center; min-width: 80px;";
    
    forms.forEach((form, idx) => {
        if (!form.is_default && idx > 0) {
            const line = document.createElement('div');
            line.style.cssText = "width: 30px; height: 1px; background: #e2e8f0; margin: 2px 0;";
            formsBox.appendChild(line);
        }
        const isCurrent = form.pokemon.name === currentPoke.poke.name;
        const formId = form.pokemon.url.split('/').slice(-2, -1)[0];
        const name = form.is_default ? stage.species.name : form.pokemon.name.split('-')[1];
        
        formsBox.innerHTML += `
            <div onclick="loadPokemon('${form.pokemon.name}')" style="cursor:pointer; text-align:center; padding:5px; width:100%; ${isCurrent ? 'background:#e2e8f0; border-radius:12px; border:2px solid var(--accent);' : ''}">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home/${formId}.png" style="width:50px;">
                <div style="font-weight:900; font-size:8px;">${name.toUpperCase()}</div>
            </div>`;
    });

    column.appendChild(formsBox);
    targetContainer.appendChild(column);

    // 2. Handle Branching: Each path gets its own arrow and label
    if (stage.evolves_to.length > 0) {
        const branchWrapper = document.createElement('div');
        branchWrapper.style.cssText = "display: flex; flex-direction: column; gap: 15px; justify-content: center;";
        targetContainer.appendChild(branchWrapper);
        
        for (const next of stage.evolves_to) {
            const pathContainer = document.createElement('div');
            pathContainer.style.cssText = "display: flex; align-items: center;";
            branchWrapper.appendChild(pathContainer);

            // Create specific connector for THIS branch
            // Inside your branch loop...
const details = next.evolution_details[0];
let methodText = "LEVEL UP"; 

if (details) {
    const parts = [];
    
    // 1. REMAP LOCATIONS TO STONES (Modern standard)
   if (details.location) {
    const loc = details.location.name.toLowerCase();

    // 1. LEAF STONE / MOSS ROCK LOCATIONS
    if (loc.includes('moss') || loc.includes('eterna-forest') || loc.includes('pinwheel-forest') || loc.includes('petalburg-woods')) {
        parts.push("LEAF STONE");
    } 
    // 2. ICE STONE / ICY ROCK LOCATIONS
    else if (loc.includes('sinnoh') || loc.includes('frost') || loc.includes('lanakila') || loc.includes('twist-mountain')) {
        parts.push("ICE STONE");
    } 
    // 3. THUNDER STONE / MAGNETIC FIELD LOCATIONS
    else if (loc.includes('magnetic') || loc.includes('coronet') || loc.includes('chargestone') || loc.includes('mauville') || loc.includes('kalos-route-13')) {
        parts.push("THUNDER STONE");
    } 
    // 4. FALLBACK (for any unique locations not covered by stones)
    else {
        parts.push(`AT ${details.location.name.replace(/-/g, ' ').toUpperCase()}`);
    }
}
// 1. Fairy-type move check (Sylveon)
if (details.known_move_type) {
    const typeName = details.known_move_type.name.toUpperCase();
    parts.push(`KNOWS ${typeName} MOVE`);
}

// 2. Friendship/Affection check (Sylveon + others)
if (details.min_happiness || details.min_affection) {
    let friendStr = "FRIENDSHIP";
    
    // Add time of day if specific (Espeon/Umbreon)
    if (details.time_of_day) {
        friendStr += ` (${details.time_of_day.toUpperCase()})`;
    }
    
    parts.push(friendStr);
}
    // 2. Standard Stone/Item Trigger
    if (details.item) {
        parts.push(details.item.name.replace(/-/g, ' ').toUpperCase());
    }

    // 3. Friendship & Time
    if (details.min_happiness) {
        let friendStr = "FRIENDSHIP";
        if (details.time_of_day) friendStr += ` (${details.time_of_day.toUpperCase()})`;
        parts.push(friendStr);
    }

    // 4. Standard Triggers
    if (details.min_level) parts.push(`LVL ${details.min_level}`);
    if (details.trigger.name === 'trade') parts.push("TRADE");
    if (details.held_item) parts.push(`HOLD ${details.held_item.name.replace(/-/g, ' ').toUpperCase()}`);
    if (details.known_move) parts.push(`MOVE: ${details.known_move.name.toUpperCase()}`);
    
    // 5. Cleanup and deduplicate
    const uniqueParts = [...new Set(parts)];
    
    // Final check: If a location was remapped to a stone that was already there, 
    // Set() ensures it only shows once.
    methodText = uniqueParts.length > 0 ? uniqueParts.join(' + ') : details.trigger.name.replace(/-/g, ' ').toUpperCase();
}

// UI Connector
const connector = document.createElement('div');
connector.style.cssText = "display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 85px; padding: 0 5px;";
connector.innerHTML = `
    <span style="font-size: 7px; font-weight: 900; color: var(--silver-dark); margin-bottom: -4px; text-align: center; line-height: 1.1;">
        ${methodText}
    </span>
    <span style="color: #cbd5e1; font-size: 20px;">→</span>
`;
            
            pathContainer.appendChild(connector);
            await renderBranch(next, pathContainer);
        }
    }
}
}

</script>
</body>
</html>




